#!/bin/bash
# ========================================
# –°–∫—Ä–∏–ø—Ç –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á
# ========================================
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤ (1-12)
# –∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

echo "========================================"
echo "üöÄ –ú–ê–°–°–û–í–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø –ó–ê–î–ê–ß"
echo "========================================"
echo ""

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -d "venv" ]; then
    echo "‚ö†Ô∏è  –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!"
    exit 1
fi

source venv/bin/activate

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
PROBLEMS_PER_GRADE=10
DELAY=2.0

# –°—á–µ—Ç—á–∏–∫–∏
TOTAL_PROBLEMS=0
SUCCESS_COUNT=0
ERROR_COUNT=0

echo "üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:"
echo "   - –ó–∞–¥–∞—á –Ω–∞ –∫–ª–∞—Å—Å: $PROBLEMS_PER_GRADE"
echo "   - –ó–∞–¥–µ—Ä–∂–∫–∞: $DELAY —Å–µ–∫"
echo ""

# ========================================
# –ß–ê–°–¢–¨ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è —à–∫–æ–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ (1-12)
# ========================================

echo "üìö –ß–ê–°–¢–¨ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á –¥–ª—è —à–∫–æ–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ (1-12)"
echo "========================================"
echo ""

for grade in {1..12}; do
    echo "üìù –ö–ª–∞—Å—Å $grade..."
    
    if python manage.py generate_problems_bulk --count $PROBLEMS_PER_GRADE --grade $grade --delay $DELAY; then
        SUCCESS_COUNT=$((SUCCESS_COUNT + PROBLEMS_PER_GRADE))
        echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: $PROBLEMS_PER_GRADE –∑–∞–¥–∞—á"
    else
        ERROR_COUNT=$((ERROR_COUNT + PROBLEMS_PER_GRADE))
        echo "   ‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–ª–∞—Å—Å–∞ $grade"
    fi
    
    TOTAL_PROBLEMS=$((TOTAL_PROBLEMS + PROBLEMS_PER_GRADE))
    echo ""
done

# ========================================
# –ß–ê–°–¢–¨ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
# ========================================

echo "üéØ –ß–ê–°–¢–¨ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏"
echo "========================================"
echo ""

# –ú–∞—Å—Å–∏–≤ —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
declare -a LEVELS=(
    "–ù–∞—á–∞–ª—å–Ω—ã–π:0:300:10"
    "–õ–µ–≥–∫–∏–π:300:600:10"
    "–°—Ä–µ–¥–Ω–∏–π:600:900:10"
    "–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ:900:1200:10"
    "–°–ª–æ–∂–Ω—ã–π:1200:1500:10"
    "–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π:1500:2000:10"
    "–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π:2000:3000:10"
)

for level in "${LEVELS[@]}"; do
    IFS=':' read -r name min max count <<< "$level"
    
    echo "üéì –£—Ä–æ–≤–µ–Ω—å: $name ($min-$max)"
    
    if python manage.py generate_problems_bulk --count $count --difficulty-min $min --difficulty-max $max --delay $DELAY; then
        SUCCESS_COUNT=$((SUCCESS_COUNT + count))
        echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: $count –∑–∞–¥–∞—á"
    else
        ERROR_COUNT=$((ERROR_COUNT + count))
        echo "   ‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —É—Ä–æ–≤–Ω—è $name"
    fi
    
    TOTAL_PROBLEMS=$((TOTAL_PROBLEMS + count))
    echo ""
done

# ========================================
# –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# ========================================

echo ""
echo "========================================"
echo "üéâ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "========================================"
echo ""
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
echo "   - –í—Å–µ–≥–æ –∑–∞–¥–∞—á –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: $TOTAL_PROBLEMS"
echo "   - –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: $SUCCESS_COUNT"
echo "   - –û—à–∏–±–æ–∫: $ERROR_COUNT"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ –ë–î
echo "üìö –ü—Ä–æ–≤–µ—Ä—è–µ–º –ë–î..."
python manage.py shell -c "from problems.models import Problem; print(f'–í—Å–µ–≥–æ –∑–∞–¥–∞—á –≤ –ë–î: {Problem.objects.count()}')"

echo ""
echo "========================================"
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
echo "========================================"
