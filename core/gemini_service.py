"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Gemini API
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ò–ò
"""

import json
import re
import logging
import time
from typing import Dict, Any, Optional
from concurrent.futures import ThreadPoolExecutor
import google.generativeai as genai
from decouple import config

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger(__name__)
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

class GeminiService:
    """–ö–ª–∞—Å—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Gemini API"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Gemini"""
        api_key = config('GEMINI_API_KEY', default=None)
        if not api_key:
            raise ValueError("GEMINI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º API
        genai.configure(api_key=api_key)
        
        # –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å
        self.model = genai.GenerativeModel('gemini-2.5-flash')
    
    def generate_problem(
        self,
        topic: str,
        difficulty: int,
        user_level: int,
        user_grade: int = None,
        user_age: int = None
    ) -> Dict[str, Any]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ Gemini API
        
        Args:
            topic: –¢–µ–º–∞ –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ê–ª–≥–µ–±—Ä–∞: –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è")
            difficulty: –ñ–µ–ª–∞–µ–º–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (0-3000)
            user_level: –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–Ω–¥–µ–∫—Å –ê–ª –•–æ—Ä–∞–∑–º–∏)
            user_grade: –ö–ª–∞—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (1-12)
            user_age: –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Returns:
            Dict —Å –ø–æ–ª—è–º–∏:
                - title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏
                - latex_formula: –§–æ—Ä–º—É–ª–∞ –≤ LaTeX
                - description: –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                - correct_answer: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                - solution_steps: –°–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ —Ä–µ—à–µ–Ω–∏—è
                - hints: –°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫
                - difficulty_score: –°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏
        """
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ç–µ–º—ã
        grade_info = ""
        forbidden_topics = ""
        
        if user_grade:
            grade_info = f"\n–ö–õ–ê–°–° –£–ß–ï–ù–ò–ö–ê: {user_grade} –∫–ª–∞—Å—Å"
            if user_grade <= 4:
                grade_info += " (–Ω–∞—á–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞ - –ø—Ä–æ—Å—Ç–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞, —Å–ª–æ–∂–µ–Ω–∏–µ, –≤—ã—á–∏—Ç–∞–Ω–∏–µ, —É–º–Ω–æ–∂–µ–Ω–∏–µ, –¥–µ–ª–µ–Ω–∏–µ)"
                forbidden_topics = "\n‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –¥—Ä–æ–±–∏, —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –≥–µ–æ–º–µ—Ç—Ä–∏—è, –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞, —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª—ã"
            elif user_grade <= 6:
                grade_info += " (5-6 –∫–ª–∞—Å—Å - –¥—Ä–æ–±–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø—Ä–æ—Å—Ç—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø–ª–æ—â–∞–¥–∏ —Ñ–∏–≥—É—Ä)"
                forbidden_topics = "\n‚ùå –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û: –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞, —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª—ã, –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏, —Å–æ—á–µ—Ç–∞–Ω–∏—è, –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, —Å—Ç–µ–ø–µ–Ω–∏ –≤—ã—à–µ 2"
            elif user_grade <= 9:
                grade_info += " (7-9 –∫–ª–∞—Å—Å - –∞–ª–≥–µ–±—Ä–∞, –≥–µ–æ–º–µ—Ç—Ä–∏—è, –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø—Ä–æ—Å—Ç–∞—è –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞)"
                forbidden_topics = "\n‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ, –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã, –ª–æ–≥–∞—Ä–∏—Ñ–º—ã, —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è (–∫—Ä–æ–º–µ –±–∞–∑–æ–≤–æ–π)"
            elif user_grade <= 11:
                grade_info += " (10-11 –∫–ª–∞—Å—Å - —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ, –ª–æ–≥–∞—Ä–∏—Ñ–º—ã)"
                forbidden_topics = ""
            else:
                grade_info += " (–≤—ã–ø—É—Å–∫–Ω–∏–∫ - –æ–ª–∏–º–ø–∏–∞–¥–Ω—ã–µ –∑–∞–¥–∞—á–∏)"
                forbidden_topics = ""
        elif user_age:
            grade_info = f"\n–í–û–ó–†–ê–°–¢: {user_age} –ª–µ—Ç"
        
        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –∏ –ø–µ–¥–∞–≥–æ–≥. –°–æ–∑–¥–∞–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É.

–¢–ï–ú–ê: {topic}
–°–õ–û–ñ–ù–û–°–¢–¨: {difficulty} (—à–∫–∞–ª–∞ 0-3000, –≥–¥–µ 1000 - —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)
–£–†–û–í–ï–ù–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_level}{grade_info}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ó–∞–¥–∞—á–∞ –î–û–õ–ñ–ù–ê —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞!
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–Ω—è—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑—É—á–∞—é—Ç –≤ —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ!{forbidden_topics}

–ü–†–ò–ú–ï–†–´ –ü–û–î–•–û–î–Ø–©–ò–• –ó–ê–î–ê–ß –î–õ–Ø 5-6 –ö–õ–ê–°–°–ê:
‚úÖ "–ù–∞–π–¥–∏—Ç–µ —Å—É–º–º—É –¥—Ä–æ–±–µ–π 2/5 + 1/3"
‚úÖ "–°–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 15 –æ—Ç 60?"
‚úÖ "–†–µ—à–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: x + 7 = 20"
‚úÖ "–ù–∞–π–¥–∏—Ç–µ –ø–ª–æ—â–∞–¥—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 8 —Å–º –∏ 5 —Å–º"
‚úÖ "–£ –ú–∞—à–∏ –±—ã–ª–æ 100 —Ä—É–±–ª–µ–π. –û–Ω–∞ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∞ 30%. –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å?"

–ü–†–ò–ú–ï–†–´ –ù–ï–ü–û–î–•–û–î–Ø–©–ò–• –ó–ê–î–ê–ß –î–õ–Ø 5-6 –ö–õ–ê–°–°–ê:
‚ùå –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞ —Å —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞–º–∏
‚ùå –ü–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ —Å–æ—á–µ—Ç–∞–Ω–∏—è
‚ùå –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è
‚ùå –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è
‚ùå –ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –∏ –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ó–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–º–µ, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ò –∫–ª–∞—Å—Å—É —É—á–µ–Ω–∏–∫–∞
2. –§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ LaTeX (–±–µ–∑ $$ –∏–ª–∏ $)
3. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —á–∏—Å–ª–æ–º –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º
4. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–º–∏–Ω–∏–º—É–º 4 —à–∞–≥–∞)
5. –î–æ–±–∞–≤—å 2-3 –ø–æ–ª–µ–∑–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{{
    "title": "–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏",
    "latex_formula": "—Ñ–æ—Ä–º—É–ª–∞ –≤ LaTeX –±–µ–∑ $$ –∏–ª–∏ $",
    "description": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏ —á—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏",
    "correct_answer": "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (—á–∏—Å–ª–æ –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ)",
    "solution_steps": [
        "–®–∞–≥ 1: ...",
        "–®–∞–≥ 2: ...",
        "–®–∞–≥ 3: ...",
        "–®–∞–≥ 4: ..."
    ],
    "hints": [
        "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1",
        "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2"
    ],
    "difficulty_score": {difficulty}
}}

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!"""

        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        start_time = time.time()
        logger.info(f"üöÄ –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ | –¢–µ–º–∞: {topic} | –°–ª–æ–∂–Ω–æ—Å—Ç—å: {difficulty} | –ö–ª–∞—Å—Å: {user_grade or '–Ω–µ —É–∫–∞–∑–∞–Ω'}")

        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å
            response = self.model.generate_content(prompt)
            
            generation_time = time.time() - start_time
            logger.info(f"‚è±Ô∏è  Gemini API –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ {generation_time:.2f} —Å–µ–∫")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            response_text = response.text.strip()
            
            # –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if response_text.startswith('```json'):
                response_text = response_text[7:]
            if response_text.startswith('```'):
                response_text = response_text[3:]
            if response_text.endswith('```'):
                response_text = response_text[:-3]
            
            response_text = response_text.strip()
            
            # –ü–∞—Ä—Å–∏–º JSON
            problem_data = json.loads(response_text)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            required_fields = [
                'title', 'latex_formula', 'description',
                'correct_answer', 'solution_steps', 'hints'
            ]
            for field in required_fields:
                if field not in problem_data:
                    raise ValueError(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: {field}")
            
            # –î–æ–±–∞–≤–ª—è–µ–º difficulty_score –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            if 'difficulty_score' not in problem_data:
                problem_data['difficulty_score'] = difficulty
            
            total_time = time.time() - start_time
            logger.info(f"‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ: '{problem_data['title']}' | –û–±—â–µ–µ –≤—Ä–µ–º—è: {total_time:.2f} —Å–µ–∫")
            
            return problem_data
            
        except json.JSONDecodeError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}")
            logger.debug(f"–û—Ç–≤–µ—Ç Gemini: {response_text[:500]}...")
            raise ValueError(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}\n–û—Ç–≤–µ—Ç: {response_text}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏: {e}")
            raise Exception(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ Gemini: {e}")
    
    def check_solution(
        self,
        problem_data: Dict[str, Any],
        user_answer: str,
        solution_photo: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Gemini API
        
        Args:
            problem_data: –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (title, latex_formula, description, correct_answer)
            user_answer: –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            solution_photo: –ü—É—Ç—å –∫ —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            Dict —Å –ø–æ–ª—è–º–∏:
                - is_correct: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ä–µ—à–µ–Ω–∏–µ
                - feedback: –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                - detailed_analysis: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ)
                - confidence: –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ò–ò (0-1)
        """
        
        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –ü—Ä–æ–≤–µ—Ä—å —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏.

–ó–ê–î–ê–ß–ê:
–ù–∞–∑–≤–∞–Ω–∏–µ: {problem_data.get('title', '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞')}
–§–æ—Ä–º—É–ª–∞: {problem_data.get('latex_formula', '')}
–û–ø–∏—Å–∞–Ω–∏–µ: {problem_data.get('description', '')}

–ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢: {problem_data.get('correct_answer', '')}
–û–¢–í–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_answer}

–ó–ê–î–ê–ù–ò–ï:
1. –û–ø—Ä–µ–¥–µ–ª–∏, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –£—á–∏—Ç—ã–≤–∞–π –≤–æ–∑–º–æ–∂–Ω—ã–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.5 –∏ 1/2)
3. –î–∞–π –∫—Ä–∞—Ç–∫—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
4. –û—Ü–µ–Ω–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ (0.0 - 1.0)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{{
    "is_correct": true/false,
    "feedback": "–ö—Ä–∞—Ç–∫–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    "confidence": 0.95,
    "explanation": "–ü–æ—á–µ–º—É –æ—Ç–≤–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"
}}

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON!"""

        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å
            response = self.model.generate_content(prompt)
            
            response_text = response.text.strip()
            
            # –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if response_text.startswith('```json'):
                response_text = response_text[7:]
            if response_text.startswith('```'):
                response_text = response_text[3:]
            if response_text.endswith('```'):
                response_text = response_text[:-3]
            
            response_text = response_text.strip()
            
            # –ü–∞—Ä—Å–∏–º JSON
            check_result = json.loads(response_text)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if 'is_correct' not in check_result:
                raise ValueError("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ is_correct –≤ –æ—Ç–≤–µ—Ç–µ")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            check_result.setdefault('feedback', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
            check_result.setdefault('confidence', 0.9)
            check_result.setdefault('explanation', '')
            
            return check_result
            
        except json.JSONDecodeError as e:
            raise ValueError(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}")
        except Exception as e:
            raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini: {e}")
    
    def analyze_photo_solution(
        self,
        problem_data: Dict[str, Any],
        photo_path: str
    ) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini Vision API
        
        Args:
            problem_data: –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            photo_path: –ü—É—Ç—å –∫ —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è
        
        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        """
        
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini Vision
        # –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å multimodal –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Gemini
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä—É–∫–æ–ø–∏—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.

–ó–ê–î–ê–ß–ê:
{problem_data.get('description', '')}
–§–æ—Ä–º—É–ª–∞: {problem_data.get('latex_formula', '')}
–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {problem_data.get('correct_answer', '')}

–ó–ê–î–ê–ù–ò–ï:
1. –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ —à–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è –≤–∏–¥–Ω—ã –Ω–∞ —Ñ–æ—Ç–æ
2. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
3. –ù–∞–π–¥–∏ –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
4. –û—Ü–µ–Ω–∏ –ø–æ–ª–Ω–æ—Ç—É —Ä–µ—à–µ–Ω–∏—è

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
{{
    "detected_steps": ["–®–∞–≥ 1...", "–®–∞–≥ 2..."],
    "errors_found": ["–û—à–∏–±–∫–∞ 1...", "–û—à–∏–±–∫–∞ 2..."],
    "is_complete": true/false,
    "overall_correctness": 0.85,
    "feedback": "–û–±—â–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å"
}}"""
        
        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        # –í production –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        return {
            "analyzed": True,
            "detected_steps": ["–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ —Ç—Ä–µ–±—É–µ—Ç Gemini Vision API"],
            "errors_found": [],
            "is_complete": True,
            "overall_correctness": 0.9,
            "feedback": "–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Gemini Vision."
        }


# Singleton instance
_gemini_service = None

def get_gemini_service() -> GeminiService:
    """–ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä GeminiService (Singleton)"""
    global _gemini_service
    if _gemini_service is None:
        _gemini_service = GeminiService()
    return _gemini_service
