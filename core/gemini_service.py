"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Gemini API
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ò–ò
"""

import json
import re
import logging
import time
from typing import Dict, Any, Optional
from concurrent.futures import ThreadPoolExecutor
import google.generativeai as genai
from decouple import config
from .math_validator import get_math_validator
from .math_topics_database import get_topic_by_difficulty, get_random_topic_for_grade

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger(__name__)
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

class GeminiService:
    """–ö–ª–∞—Å—Å –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Gemini API"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ Gemini"""
        api_key = config('GEMINI_API_KEY', default=None)
        if not api_key:
            raise ValueError("GEMINI_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º API
        genai.configure(api_key=api_key)
        
        # –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å
        self.model = genai.GenerativeModel('gemini-2.5-flash')
    
    def _parse_gemini_json(self, response_text: str) -> Dict[str, Any]:
        """
        –ù–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç Gemini —Å –æ—á–∏—Å—Ç–∫–æ–π –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        """
        import re
        
        # –°–ø–∏—Å–æ–∫ –ø–æ–ø—ã—Ç–æ–∫ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç –ø—Ä–æ—Å—Ç–æ–π –∫ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π
        attempts = [
            # –ü–æ–ø—ã—Ç–∫–∞ 1: –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            lambda t: t,
            # –ü–æ–ø—ã—Ç–∫–∞ 2: –ó–∞–º–µ–Ω—è–µ–º –¥–≤–æ–π–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏
            lambda t: t.replace('\\\\', '\\'),
            # –ü–æ–ø—ã—Ç–∫–∞ 3: –ó–∞–º–µ–Ω—è–µ–º LaTeX –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ —Å–∏–º–≤–æ–ª—ã
            lambda t: t.replace('\\cdot', '*').replace('\\div', '/').replace('\\times', '*'),
            # –ü–æ–ø—ã—Ç–∫–∞ 4: –£–¥–∞–ª—è–µ–º –≤—Å–µ LaTeX –∫–æ–º–∞–Ω–¥—ã —Ç–∏–ø–∞ \text{...}
            lambda t: re.sub(r'\\text\{([^}]*)\}', r'\1', t),
            # –ü–æ–ø—ã—Ç–∫–∞ 5: –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏ –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É (–∫—Ä–æ–º–µ \n, \t)
            lambda t: re.sub(r'\\(?![nt"])', '', t),
            # –ü–æ–ø—ã—Ç–∫–∞ 6: –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ - —É–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
            lambda t: t.replace('\\', '').replace('\n', ' '),
        ]
        
        last_error = None
        for i, clean_func in enumerate(attempts):
            try:
                cleaned = clean_func(response_text)
                result = json.loads(cleaned)
                if i > 0:
                    logger.info(f"‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ {i + 1}")
                return result
            except json.JSONDecodeError as e:
                last_error = e
                continue
        
        # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å, –ª–æ–≥–∏—Ä—É–µ–º –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        logger.error(f"‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å: {last_error}")
        logger.error(f"–û—Ç–≤–µ—Ç Gemini (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤): {response_text[:500]}")
        raise ValueError(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {last_error}")
    
    def generate_problem(
        self,
        topic: str,
        difficulty: int,
        user_level: int,
        user_grade: int = None,
        user_age: int = None
    ) -> Dict[str, Any]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É —á–µ—Ä–µ–∑ Gemini API
        
        Args:
            topic: –¢–µ–º–∞ –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ê–ª–≥–µ–±—Ä–∞: –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è")
            difficulty: –ñ–µ–ª–∞–µ–º–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (0-3000)
            user_level: –£—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–Ω–¥–µ–∫—Å –ê–ª –•–æ—Ä–∞–∑–º–∏)
            user_grade: –ö–ª–∞—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (1-12)
            user_age: –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Returns:
            Dict —Å –ø–æ–ª—è–º–∏:
                - title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏
                - latex_formula: –§–æ—Ä–º—É–ª–∞ –≤ LaTeX
                - description: –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                - correct_answer: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                - solution_steps: –°–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ —Ä–µ—à–µ–Ω–∏—è
                - hints: –°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫
                - difficulty_score: –°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏
        """
        
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–º—É –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 1010+ —Ç–µ–º
        topic_param = "topic"
        
        if topic_param:
            topic_name = topic_param
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ 1010+ —Ç–µ–º
            # –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–º—É –ø–æ –∫–ª–∞—Å—Å—É –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            if user_grade:
                topic_obj = get_random_topic_for_grade(user_grade)
                if topic_obj:
                    topic_name = f"{topic_obj['category']}: {topic_obj['topic']}"
                    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã
                    target_difficulty = (topic_obj['difficulty_min'] + topic_obj['difficulty_max']) // 2
                    logger.info(f"üìö –í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞ –∏–∑ –±–∞–∑—ã: {topic_name} | –°–ª–æ–∂–Ω–æ—Å—Ç—å: {target_difficulty}")
                else:
                    # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É
                    topic_name = "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –û–±—â–∏–µ –∑–∞–¥–∞—á–∏"
            else:
                # –ï—Å–ª–∏ –∫–ª–∞—Å—Å –Ω–µ —É–∫–∞–∑–∞–Ω, –≤—ã–±–∏—Ä–∞–µ–º –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                topic_obj = get_topic_by_difficulty(difficulty)
                if topic_obj:
                    topic_name = f"{topic_obj['category']}: {topic_obj['topic']}"
                    logger.info(f"üìö –í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: {topic_name}")
                else:
                    topic_name = "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –û–±—â–∏–µ –∑–∞–¥–∞—á–∏"
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ç–µ–º—ã
        grade_info = ""
        forbidden_topics = ""
        
        if user_grade:
            grade_info = f"\n–ö–õ–ê–°–° –£–ß–ï–ù–ò–ö–ê: {user_grade} –∫–ª–∞—Å—Å"
            if user_grade <= 4:
                grade_info += " (–Ω–∞—á–∞–ª—å–Ω–∞—è —à–∫–æ–ª–∞ - –ø—Ä–æ—Å—Ç–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞, —Å–ª–æ–∂–µ–Ω–∏–µ, –≤—ã—á–∏—Ç–∞–Ω–∏–µ, —É–º–Ω–æ–∂–µ–Ω–∏–µ, –¥–µ–ª–µ–Ω–∏–µ)"
                forbidden_topics = "\n‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –¥—Ä–æ–±–∏, —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –≥–µ–æ–º–µ—Ç—Ä–∏—è, –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞, —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª—ã"
            elif user_grade <= 6:
                grade_info += " (5-6 –∫–ª–∞—Å—Å - –¥—Ä–æ–±–∏, –ø—Ä–æ—Ü–µ–Ω—Ç—ã, –ø—Ä–æ—Å—Ç—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø–ª–æ—â–∞–¥–∏ —Ñ–∏–≥—É—Ä)"
                forbidden_topics = "\n‚ùå –°–¢–†–û–ì–û –ó–ê–ü–†–ï–©–ï–ù–û: –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞, —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª—ã, –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏, —Å–æ—á–µ—Ç–∞–Ω–∏—è, –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, —Å—Ç–µ–ø–µ–Ω–∏ –≤—ã—à–µ 2"
            elif user_grade <= 9:
                grade_info += " (7-9 –∫–ª–∞—Å—Å - –∞–ª–≥–µ–±—Ä–∞, –≥–µ–æ–º–µ—Ç—Ä–∏—è, –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø—Ä–æ—Å—Ç–∞—è –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞)"
                forbidden_topics = "\n‚ùå –ó–ê–ü–†–ï–©–ï–ù–û: –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ, –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã, –ª–æ–≥–∞—Ä–∏—Ñ–º—ã, —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è (–∫—Ä–æ–º–µ –±–∞–∑–æ–≤–æ–π)"
            elif user_grade <= 11:
                grade_info += " (10-11 –∫–ª–∞—Å—Å - —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ, –ª–æ–≥–∞—Ä–∏—Ñ–º—ã)"
                forbidden_topics = ""
            else:
                grade_info += " (–≤—ã–ø—É—Å–∫–Ω–∏–∫ - –æ–ª–∏–º–ø–∏–∞–¥–Ω—ã–µ –∑–∞–¥–∞—á–∏)"
                forbidden_topics = ""
        elif user_age:
            grade_info = f"\n–í–û–ó–†–ê–°–¢: {user_age} –ª–µ—Ç"
        
        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –∏ –ø–µ–¥–∞–≥–æ–≥. –°–æ–∑–¥–∞–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–¥–∞—á—É.

–¢–ï–ú–ê: {topic}
–°–õ–û–ñ–ù–û–°–¢–¨: {difficulty} (—à–∫–∞–ª–∞ 0-3000, –≥–¥–µ 1000 - —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)
–£–†–û–í–ï–ù–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_level}{grade_info}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ó–∞–¥–∞—á–∞ –î–û–õ–ñ–ù–ê —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞!
- –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–Ω—è—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑—É—á–∞—é—Ç –≤ —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ!{forbidden_topics}

–ü–†–ò–ú–ï–†–´ –ü–û–ù–Ø–¢–ù–´–• –ó–ê–î–ê–ß –î–õ–Ø –†–ê–ó–ù–´–• –ö–õ–ê–°–°–û–í:

5-6 –ö–õ–ê–°–°:
‚úÖ "–£ –ú–∞—à–∏ –±—ã–ª–æ 100 —Ä—É–±–ª–µ–π. –û–Ω–∞ –∫—É–ø–∏–ª–∞ –∫–Ω–∏–≥—É –∑–∞ 30% —ç—Ç–æ–π —Å—É–º–º—ã. –°–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –æ—Å—Ç–∞–ª–æ—Å—å —É –ú–∞—à–∏?"
‚úÖ "–°–∞–¥ –∏–º–µ–µ—Ç –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—É—é —Ñ–æ—Ä–º—É —Å–æ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ 8 –º –∏ 5 –º. –ù–∞–π–¥–∏—Ç–µ –ø–ª–æ—â–∞–¥—å —Å–∞–¥–∞."
‚úÖ "–†–µ—à–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: x + 7 = 20. –ù–∞–π–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ x."
‚úÖ "–í –∫–ª–∞—Å—Å–µ 25 —É—á–µ–Ω–∏–∫–æ–≤, 60% –∏–∑ –Ω–∏—Ö –º–∞–ª—å—á–∏–∫–∏. –°–∫–æ–ª—å–∫–æ –º–∞–ª—å—á–∏–∫–æ–≤ –≤ –∫–ª–∞—Å—Å–µ?"

7-9 –ö–õ–ê–°–°:
‚úÖ "–ù–∞–π–¥–∏—Ç–µ –∫–æ—Ä–Ω–∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è: x¬≤ - 5x + 6 = 0"
‚úÖ "–¢–æ—á–∫–∞ –¥–≤–∏–∂–µ—Ç—Å—è –ø–æ –ø—Ä—è–º–æ–π —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 15 –º/—Å. –ö–∞–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ–Ω–∞ –ø—Ä–æ–π–¥–µ—Ç –∑–∞ 4 –º–∏–Ω—É—Ç—ã?"
‚úÖ "–í —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–µ ABC —É–≥–æ–ª A = 60¬∞, —É–≥–æ–ª B = 80¬∞. –ù–∞–π–¥–∏—Ç–µ —É–≥–æ–ª C."

10-11 –ö–õ–ê–°–°:
‚úÖ "–†–µ—à–∏—Ç–µ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: sin(x) = 1/2 –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ [0; 2œÄ]"
‚úÖ "–ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–∏: f(x) = x¬≥ - 2x¬≤ + 5x - 1"
‚úÖ "–í—ã—á–∏—Å–ª–∏—Ç–µ –ø–ª–æ—â–∞–¥—å —Ñ–∏–≥—É—Ä—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞—Ä–∞–±–æ–ª–æ–π y = x¬≤ –∏ –ø—Ä—è–º–æ–π y = 4"

–í–ê–ñ–ù–û: –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –ß–ï–¢–ö–û–ï —É—Å–ª–æ–≤–∏–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å!

üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –†–ï–®–ï–ù–ò–Æ:
1. –ó–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–º–µ, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ò –∫–ª–∞—Å—Å—É —É—á–µ–Ω–∏–∫–∞
2. –§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ LaTeX (–±–µ–∑ $$ –∏–ª–∏ $)
3. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —á–∏—Å–ª–æ–º –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º
4. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–º–∏–Ω–∏–º—É–º 4 —à–∞–≥–∞)
5. –î–æ–±–∞–≤—å 2-3 –ø–æ–ª–µ–∑–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–û–í–ï–†–ö–ê –†–ï–®–ï–ù–ò–Ø:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—å –∫–∞–∂–¥—ã–π —à–∞–≥ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
- –ü–æ–¥—Å—Ç–∞–≤—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ —É–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω –≤–µ—Ä–µ–Ω
- –î–ª—è –∏—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—å –û–î–ó (–æ–±–ª–∞—Å—Ç—å –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
- –î–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —É—Ä–∞–≤–Ω–µ–Ω–∏–π –ø—Ä–æ–≤–µ—Ä—å —á–µ—Ä–µ–∑ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç
- –ù–ï –≤–∫–ª—é—á–∞–π –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∫–æ—Ä–Ω–∏ –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
- –í—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ—á–Ω—ã–º–∏, –±–µ–∑ –æ—à–∏–±–æ–∫ –≤ –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–µ

üìê –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –ò–†–†–ê–¶–ò–û–ù–ê–õ–¨–ù–´–• –£–†–ê–í–ù–ï–ù–ò–ô:
- –ü—Ä–æ–≤–µ—Ä—å –û–î–ó: –ø–æ–¥ –∫–æ—Ä–Ω–µ–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 0
- –ü–æ—Å–ª–µ –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è –≤ –∫–≤–∞–¥—Ä–∞—Ç –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—å –≤—Å–µ –∫–æ—Ä–Ω–∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π
- –û—Ç–±—Ä–æ—Å—å –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∫–æ—Ä–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç –∏—Å—Ö–æ–¥–Ω–æ–º—É —É—Ä–∞–≤–Ω–µ–Ω–∏—é

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{{
    "title": "–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏",
    "problem_text": "–ß–ï–¢–ö–ò–ô –∏ –ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏ - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ü–û–õ–ï!",
    "description": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏",
    "equation_to_solve": "–£—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–∑ —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å) –≤ —Ñ–æ—Ä–º–∞—Ç–µ LaTeX",
    "correct_answer": "–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (—á–∏—Å–ª–æ –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ)",
    "solution_formula": "–§–æ—Ä–º—É–ª–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)",
    "solution_steps": [
        "–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞—á–∏",
        "–®–∞–≥ 2: –í—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ —Ä–µ—à–µ–Ω–∏—è", 
        "–®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π",
        "–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞",
        "–®–∞–≥ 5: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç"
    ],
    "hints": [
        "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 1: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –±–µ–∑ –≥–æ—Ç–æ–≤—ã—Ö —Ñ–æ—Ä–º—É–ª",
        "–ü–æ–¥—Å–∫–∞–∑–∫–∞ 2: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–≤–µ—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è"
    ],
    "difficulty_score": {difficulty},
    "self_check": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π"
}}

üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø –ü–û–ù–ò–ú–ù–û–°–¢–ò –ó–ê–î–ê–ß–ò:
- problem_text: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø–æ–ª–Ω–∏—Ç—å! –ß–ï–¢–ö–û –∏ –ü–û–ù–Ø–¢–ù–û –æ–ø–∏—à–∏ —É—Å–ª–æ–≤–∏–µ - —á—Ç–æ –¥–∞–Ω–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ –∏ —è—Å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
- –ò–∑–±–µ–≥–∞–π –¥–≤—É—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —É—Å–ª–æ–≤–∏–∏
- –£—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–π –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ —É—Å–ª–æ–≤–∏–∏ –∑–∞–¥–∞—á–∏
- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–º–æ–≥–∞—Ç—å, –∞ –Ω–µ –¥–∞–≤–∞—Ç—å –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –ù–ï –æ—Å—Ç–∞–≤–ª—è–π –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏!

üîß –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –î–õ–Ø JSON (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –°–û–ë–õ–Æ–î–ê–ô!):
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π LaTeX –∫–æ–º–∞–Ω–¥—ã –≤ solution_steps –∏ hints!
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Å–∏–º–≤–æ–ª—ã: * –≤–º–µ—Å—Ç–æ —É–º–Ω–æ–∂–µ–Ω–∏—è, / –≤–º–µ—Å—Ç–æ –¥–µ–ª–µ–Ω–∏—è
- –ü–∏—à–∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º: —Å–º, –º, –∫–≥, –ª
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª—ç—à–∏ (\\) –≤ —Ç–µ–∫—Å—Ç–µ!
- –ü–∏—à–∏ –¥—Ä–æ–±–∏ –∫–∞–∫: 1/3, 2/5, –∞ –ù–ï –∫–∞–∫ \\frac{{1}}{{3}}
- –ü–∏—à–∏ –∫–æ—Ä–Ω–∏ –∫–∞–∫: sqrt(x), –∞ –ù–ï –∫–∞–∫ \\sqrt{{x}}
- –ü–∏—à–∏ —Å—Ç–µ–ø–µ–Ω–∏ –∫–∞–∫: x^2, x^3, –∞ –ù–ï –∫–∞–∫ x¬≤

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞!
–ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ—à–µ–Ω–∏–µ –¥–≤–∞–∂–¥—ã, —É–±–µ–¥–∏—Å—å —á—Ç–æ –≤—Å–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!"""

        # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        start_time = time.time()
        logger.info(f"üöÄ –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ | –¢–µ–º–∞: {topic} | –°–ª–æ–∂–Ω–æ—Å—Ç—å: {difficulty} | –ö–ª–∞—Å—Å: {user_grade or '–Ω–µ —É–∫–∞–∑–∞–Ω'}")

        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å
            response = self.model.generate_content(prompt)
            
            generation_time = time.time() - start_time
            logger.info(f"‚è±Ô∏è  Gemini API –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ {generation_time:.2f} —Å–µ–∫")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            response_text = response.text.strip()
            
            # –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if response_text.startswith('```json'):
                response_text = response_text[7:]
            if response_text.startswith('```'):
                response_text = response_text[3:]
            if response_text.endswith('```'):
                response_text = response_text[:-3]
            
            response_text = response_text.strip()
            
            # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ JSON –æ—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö LaTeX —Å–∏–º–≤–æ–ª–æ–≤
            problem_data = self._parse_gemini_json(response_text)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            required_fields = [
                'title', 'problem_text', 'description',
                'correct_answer', 'solution_steps', 'hints'
            ]
            for field in required_fields:
                if field not in problem_data:
                    raise ValueError(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: {field}")
                if field == 'problem_text' and not problem_data[field].strip():
                    raise ValueError("–ü–æ–ª–µ problem_text –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!")
                if field == 'title' and not problem_data[field].strip():
                    raise ValueError("–ü–æ–ª–µ title –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å –ª–∏–±–æ equation_to_solve –ª–∏–±–æ solution_formula
            if 'equation_to_solve' not in problem_data and 'solution_formula' not in problem_data:
                logger.warning("–ù–µ—Ç –Ω–∏ equation_to_solve –Ω–∏ solution_formula - –≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞")
            
            # –î–æ–±–∞–≤–ª—è–µ–º difficulty_score –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            if 'difficulty_score' not in problem_data:
                problem_data['difficulty_score'] = difficulty
            
            # üî¥ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø –†–ï–®–ï–ù–ò–Ø —á–µ—Ä–µ–∑ SymPy
            logger.info(f"üîç –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ SymPy")
            validation_passed = self._validate_problem_solution(problem_data)
            
            if not validation_passed:
                logger.warning(f"‚ö†Ô∏è –†–µ—à–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—à–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏—é, —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É")
                # –ü—Ä–æ–±—É–µ–º —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É –æ–¥–∏–Ω —Ä–∞–∑
                return self.generate_problem(topic, difficulty, user_level, user_grade, user_age)
            
            total_time = time.time() - start_time
            logger.info(f"‚úÖ –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ: '{problem_data['title']}' | –û–±—â–µ–µ –≤—Ä–µ–º—è: {total_time:.2f} —Å–µ–∫")
            
            return problem_data
            
        except json.JSONDecodeError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}")
            logger.debug(f"–û—Ç–≤–µ—Ç Gemini: {response_text[:500]}...")
            raise ValueError(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}\n–û—Ç–≤–µ—Ç: {response_text}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏: {e}")
            raise Exception(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ Gemini: {e}")
    
    def check_solution(
        self,
        problem_data: Dict[str, Any],
        user_answer: str,
        solution_photo: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ Gemini API
        
        Args:
            problem_data: –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (title, latex_formula, description, correct_answer)
            user_answer: –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            solution_photo: –ü—É—Ç—å –∫ —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        Returns:
            Dict —Å –ø–æ–ª—è–º–∏:
                - is_correct: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ä–µ—à–µ–Ω–∏–µ
                - feedback: –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                - detailed_analysis: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ)
                - confidence: –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ò–ò (0-1)
        """
        
        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –ü—Ä–æ–≤–µ—Ä—å —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏.

–ó–ê–î–ê–ß–ê:
–ù–∞–∑–≤–∞–Ω–∏–µ: {problem_data.get('title', '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞')}
–§–æ—Ä–º—É–ª–∞: {problem_data.get('latex_formula', '')}
–û–ø–∏—Å–∞–Ω–∏–µ: {problem_data.get('description', '')}

–ü–†–ê–í–ò–õ–¨–ù–´–ô –û–¢–í–ï–¢: {problem_data.get('correct_answer', '')}
–û–¢–í–ï–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_answer}

–ó–ê–î–ê–ù–ò–ï:
1. –û–ø—Ä–µ–¥–µ–ª–∏, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –£—á–∏—Ç—ã–≤–∞–π –≤–æ–∑–º–æ–∂–Ω—ã–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.5 –∏ 1/2)
3. –î–∞–π –∫—Ä–∞—Ç–∫—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
4. –û—Ü–µ–Ω–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ (0.0 - 1.0)

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON):
{{
    "is_correct": true/false,
    "feedback": "–ö—Ä–∞—Ç–∫–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    "confidence": 0.95,
    "explanation": "–ü–æ—á–µ–º—É –æ—Ç–≤–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"
}}

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON!"""

        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å
            response = self.model.generate_content(prompt)
            
            response_text = response.text.strip()
            
            # –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if response_text.startswith('```json'):
                response_text = response_text[7:]
            if response_text.startswith('```'):
                response_text = response_text[3:]
            if response_text.endswith('```'):
                response_text = response_text[:-3]
            
            response_text = response_text.strip()
            
            # –ü–∞—Ä—Å–∏–º JSON
            check_result = json.loads(response_text)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è
            if 'is_correct' not in check_result:
                raise ValueError("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ is_correct –≤ –æ—Ç–≤–µ—Ç–µ")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            check_result.setdefault('feedback', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
            check_result.setdefault('confidence', 0.9)
            check_result.setdefault('explanation', '')
            
            return check_result
            
        except json.JSONDecodeError as e:
            raise ValueError(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç Gemini: {e}")
        except Exception as e:
            raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini: {e}")
    
    def _validate_problem_solution(self, problem_data: Dict[str, Any]) -> bool:
        """
        –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ SymPy
        
        Args:
            problem_data: –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Å —Ä–µ—à–µ–Ω–∏–µ–º
        
        Returns:
            bool - –ø—Ä–æ—à–ª–∞ –ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
        """
        try:
            validator = get_math_validator()
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            # –î–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º equation_to_solve –∏–ª–∏ solution_formula
            equation = problem_data.get('equation_to_solve', '') or problem_data.get('solution_formula', '')
            correct_answer = problem_data.get('correct_answer', '')
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞—á
            if not equation or '–ø–ª–æ—â–∞–¥—å' in problem_data.get('title', '').lower():
                logger.info("‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–ª—è –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π/—Ç–µ–∫—Å—Ç–æ–≤–æ–π –∑–∞–¥–∞—á–∏")
                return True
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–¥–∞—á–∏
            is_irrational = 'sqrt' in equation.lower() or '\\sqrt' in equation
            
            # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—à–µ–Ω–∏–π)
            answers = []
            if ',' in correct_answer:
                answers = [a.strip() for a in correct_answer.split(',')]
            elif '–∏' in correct_answer:
                answers = [a.strip() for a in correct_answer.split('–∏')]
            else:
                answers = [correct_answer.strip()]
            
            # –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Ä–µ—à–µ–Ω–∏–µ
            if is_irrational:
                logger.info(f"üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –∏—Ä—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—è: {equation}")
                validation_result = validator.validate_irrational_equation(
                    equation, answers
                )
            else:
                logger.info(f"üîç –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Ä–∞–≤–Ω–µ–Ω–∏—è: {equation}")
                validation_result = validator.validate_equation_solution(
                    equation, answers
                )
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if validation_result.get('is_valid'):
                logger.info(f"‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
                return True
            else:
                logger.warning(f"‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞: {validation_result.get('errors')}")
                logger.warning(f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ SymPy: {validation_result.get('sympy_solutions')}")
                logger.warning(f"–ó–∞—è–≤–ª–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è: {answers}")
                return False
                
        except Exception as e:
            # –ï—Å–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª–æ–∂–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é: {e}")
            logger.warning("–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –¥–æ–≤–µ—Ä—è–µ–º AI")
            return True
    
    def analyze_photo_solution(
        self,
        problem_data: Dict[str, Any],
        photo_path: str
    ) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini Vision API
        
        Args:
            problem_data: –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            photo_path: –ü—É—Ç—å –∫ —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è
        
        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        """
        
        # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ Gemini Vision
        # –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å multimodal –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Gemini
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä—É–∫–æ–ø–∏—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.

–ó–ê–î–ê–ß–ê:
{problem_data.get('description', '')}
–§–æ—Ä–º—É–ª–∞: {problem_data.get('latex_formula', '')}
–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {problem_data.get('correct_answer', '')}

–ó–ê–î–ê–ù–ò–ï:
1. –û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ —à–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è –≤–∏–¥–Ω—ã –Ω–∞ —Ñ–æ—Ç–æ
2. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
3. –ù–∞–π–¥–∏ –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
4. –û—Ü–µ–Ω–∏ –ø–æ–ª–Ω–æ—Ç—É —Ä–µ—à–µ–Ω–∏—è

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (JSON):
{{
    "detected_steps": ["–®–∞–≥ 1...", "–®–∞–≥ 2..."],
    "errors_found": ["–û—à–∏–±–∫–∞ 1...", "–û—à–∏–±–∫–∞ 2..."],
    "is_complete": true/false,
    "overall_correctness": 0.85,
    "feedback": "–û–±—â–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å"
}}"""
        
        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
        # –í production –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        return {
            "analyzed": True,
            "detected_steps": ["–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ —Ç—Ä–µ–±—É–µ—Ç Gemini Vision API"],
            "errors_found": [],
            "is_complete": True,
            "overall_correctness": 0.9,
            "feedback": "–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ. –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Gemini Vision."
        }


# Singleton instance
_gemini_service = None

def get_gemini_service() -> GeminiService:
    """–ü–æ–ª—É—á–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä GeminiService (Singleton)"""
    global _gemini_service
    if _gemini_service is None:
        _gemini_service = GeminiService()
    return _gemini_service
