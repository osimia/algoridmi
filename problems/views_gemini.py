"""
Views –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–¥–∞—á–∞–º–∏ —á–µ—Ä–µ–∑ Gemini API
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é –ò–ò
"""

import logging
from concurrent.futures import ThreadPoolExecutor, TimeoutError as FuturesTimeoutError
from rest_framework import status
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.core.cache import cache
import random
from .models import UserAttempt, Topic
from core.gemini_service import get_gemini_service
from core.math_topics_database import get_random_topic_for_grade, get_topic_by_difficulty

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger(__name__)

# Thread pool –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á
# max_workers=5 –æ–∑–Ω–∞—á–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
executor = ThreadPoolExecutor(max_workers=5, thread_name_prefix="GeminiGen")


def _get_difficulty_level(score):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ –±–∞–ª–ª–∞–º"""
    if score <= 300:
        return "–ù–∞—á–∞–ª—å–Ω—ã–π"
    elif score <= 600:
        return "–õ–µ–≥–∫–∏–π"
    elif score <= 900:
        return "–°—Ä–µ–¥–Ω–∏–π"
    elif score <= 1200:
        return "–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ"
    elif score <= 1500:
        return "–°–ª–æ–∂–Ω—ã–π"
    elif score <= 2000:
        return "–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π"
    else:
        return "–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π"


def _get_estimated_time(score):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö"""
    if score <= 300:
        return "2-3 –º–∏–Ω—É—Ç—ã"
    elif score <= 600:
        return "3-5 –º–∏–Ω—É—Ç"
    elif score <= 900:
        return "5-8 –º–∏–Ω—É—Ç"
    elif score <= 1200:
        return "8-12 –º–∏–Ω—É—Ç"
    elif score <= 1500:
        return "12-15 –º–∏–Ω—É—Ç"
    elif score <= 2000:
        return "15-20 –º–∏–Ω—É—Ç"
    else:
        return "20+ –º–∏–Ω—É—Ç"


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def generate_problem_ai(request):
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ Gemini API
    GET /api/problems/generate-ai/
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - topic (optional): –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
    """
    user = request.user
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    profile = user.profile
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—è
    if not profile.is_profile_complete:
        return Response({
            'error': '–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω',
            'message': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä–µ–¥ —Ä–µ—à–µ–Ω–∏–µ–º –∑–∞–¥–∞—á',
            'profile_incomplete': True
        }, status=status.HTTP_403_FORBIDDEN)
    
    user_index = profile.al_khwarizmi_index
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª–∞—Å—Å–∞/–≤–æ–∑—Ä–∞—Å—Ç–∞
    recommended_diff = profile.recommended_difficulty
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á
    min_difficulty = max(0, recommended_diff - 150)
    max_difficulty = min(3000, recommended_diff + 150)
    target_difficulty = recommended_diff
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–º—É –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 1010+ —Ç–µ–º
    topic_param = request.query_params.get('topic')
    
    if topic_param:
        topic_name = topic_param
    else:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ 1010+ —Ç–µ–º
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–µ–º—É –ø–æ –∫–ª–∞—Å—Å—É –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        if profile.grade:
            topic_obj = get_random_topic_for_grade(profile.grade)
            if topic_obj:
                topic_name = f"{topic_obj['category']}: {topic_obj['topic']}"
                # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã
                target_difficulty = (topic_obj['difficulty_min'] + topic_obj['difficulty_max']) // 2
                logger.info(f"üìö –í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞ –∏–∑ –±–∞–∑—ã: {topic_name} | –°–ª–æ–∂–Ω–æ—Å—Ç—å: {target_difficulty}")
            else:
                # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É
                topic_name = "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –û–±—â–∏–µ –∑–∞–¥–∞—á–∏"
        else:
            # –ï—Å–ª–∏ –∫–ª–∞—Å—Å –Ω–µ —É–∫–∞–∑–∞–Ω, –≤—ã–±–∏—Ä–∞–µ–º –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            topic_obj = get_topic_by_difficulty(target_difficulty)
            if topic_obj:
                topic_name = f"{topic_obj['category']}: {topic_obj['topic']}"
                logger.info(f"üìö –í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: {topic_name}")
            else:
                topic_name = "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞: –û–±—â–∏–µ –∑–∞–¥–∞—á–∏"
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
    logger.info(f"üìù –ó–∞–ø—Ä–æ—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username} (ID: {user.id}) | –¢–µ–º–∞: {topic_name} | –°–ª–æ–∂–Ω–æ—Å—Ç—å: {target_difficulty}")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å Gemini
        gemini = get_gemini_service()
        
        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        def generate_task():
            return gemini.generate_problem(
                topic=topic_name,
                difficulty=target_difficulty,
                user_level=user_index,
                user_grade=profile.grade,
                user_age=profile.age
            )
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ thread pool —Å —Ç–∞–π–º–∞—É—Ç–æ–º 30 —Å–µ–∫—É–Ω–¥
        logger.info(f"üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–¥–∞—á–∏ –≤ thread pool | –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤: {executor._threads.__len__() if hasattr(executor, '_threads') else 'N/A'}")
        future = executor.submit(generate_task)
        
        try:
            # –ñ–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥
            problem_data = future.result(timeout=30)
            logger.info(f"‚úÖ –ó–∞–¥–∞—á–∞ –ø–æ–ª—É—á–µ–Ω–∞ –∏–∑ thread pool | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username}")
        except FuturesTimeoutError:
            logger.error(f"‚è∞ –¢–∞–π–º–∞—É—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ (30 —Å–µ–∫) | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username}")
            return Response({
                'error': '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á–∏ –∑–∞–Ω—è–ª–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'
            }, status=status.HTTP_408_REQUEST_TIMEOUT)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ –∫–µ—à–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        # –ö–ª—é—á: user_id + timestamp (–±–µ–∑ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å memcached)
        import hashlib
        title_hash = hashlib.md5(problem_data.get('title', 'temp').encode()).hexdigest()[:8]
        cache_key = f"problem_{user.id}_{title_hash}"
        cache.set(cache_key, problem_data, timeout=3600)  # 1 —á–∞—Å
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–¥–∞—á—É –ë–ï–ó –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ –ë–ï–ó —Ñ–æ—Ä–º—É–ª—ã —Ä–µ—à–µ–Ω–∏—è
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–æ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
        problem_text = problem_data.get('problem_text') or problem_data.get('description') or problem_data.get('title', '–ó–∞–¥–∞—á–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...')
        
        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
        equation = problem_data.get('equation_to_solve', '') or ''
        
        problem_response = {
            'id': cache_key,
            'topic_name': topic_name,
            'title': problem_data['title'],
            'description': problem_text,
            'difficulty_score': problem_data['difficulty_score'],
            'hints': problem_data.get('hints', []),
            'generated_by_ai': True
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º latex_formula —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ
        if equation and equation.strip():
            problem_response['latex_formula'] = equation
        
        response_data = {
            'problem': problem_response,
            'user_index': user_index,
            'difficulty_range': {
                'min': min_difficulty,
                'max': max_difficulty
            }
        }
        
        return Response(response_data, status=status.HTTP_200_OK)
        
    except ValueError as e:
        logger.error(f"‚ùå ValueError –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username} | –û—à–∏–±–∫–∞: {str(e)}")
        return Response({
            'error': f'–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏: {str(e)}',
            'detail': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GEMINI_API_KEY'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username} | –û—à–∏–±–∫–∞: {str(e)}")
        return Response({
            'error': f'–û—à–∏–±–∫–∞: {str(e)}'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def submit_answer_ai(request):
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–¥–∞—á—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —á–µ—Ä–µ–∑ Gemini API
    POST /api/problems/submit-ai/
    
    Body:
    - problem_id: ID –∑–∞–¥–∞—á–∏ (cache_key)
    - submitted_answer: –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - solution_photo: –§–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    """
    user = request.user
    
    # –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏
    logger.info(f"üì§ –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–∞ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username} (ID: {user.id})")
    logger.debug(f"Request data: {request.data}")
    logger.debug(f"Request FILES: {request.FILES}")
    
    problem_id = request.data.get('problem_id')
    submitted_answer = request.data.get('submitted_answer', '').strip()
    solution_photo = request.FILES.get('solution_photo')
    
    logger.info(f"üìã –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ | problem_id: {problem_id} | answer: '{submitted_answer}' | has_photo: {bool(solution_photo)}")
    
    if not problem_id:
        logger.warning(f"‚ö†Ô∏è  –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç problem_id | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username}")
        return Response({
            'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è problem_id'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    if not submitted_answer and not solution_photo:
        logger.warning(f"‚ö†Ô∏è  –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –∏ —Ñ–æ—Ç–æ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username}")
        return Response({
            'error': '–¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –∏–ª–∏ —Ñ–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è'
        }, status=status.HTTP_400_BAD_REQUEST)
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á—É –∏–∑ –∫–µ—à–∞
    logger.info(f"üîç –ü–æ–∏—Å–∫ –∑–∞–¥–∞—á–∏ –≤ –∫–µ—à–µ | cache_key: {problem_id}")
    problem_data = cache.get(problem_id)
    
    if not problem_data:
        logger.error(f"‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–µ—à–µ | cache_key: {problem_id} | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username}")
        return Response({
            'error': '–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è',
            'detail': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É'
        }, status=status.HTTP_404_NOT_FOUND)
    
    logger.info(f"‚úÖ –ó–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ: '{problem_data.get('title')}' | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {problem_data.get('correct_answer')}")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å Gemini
        logger.info(f"ü§ñ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ Gemini AI")
        gemini = get_gemini_service()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ò–ò
        logger.info(f"üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É | –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: '{submitted_answer}' | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: '{problem_data.get('correct_answer')}'")
        check_result = gemini.check_solution(
            problem_data=problem_data,
            user_answer=submitted_answer,
            solution_photo=solution_photo.path if solution_photo else None
        )
        
        is_correct = check_result['is_correct']
        confidence = check_result.get('confidence', 0.9)
        
        logger.info(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ: {is_correct} | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—á–∫–∏
        if solution_photo:
            points_awarded = 250 if is_correct else 50
        else:
            points_awarded = 150 if is_correct else 0
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–ø—ã—Ç–∫–µ
        attempt = UserAttempt.objects.create(
            user=user,
            problem=None,  # –ù–µ—Ç —Å–≤—è–∑–∏ —Å Problem –∏–∑ –ë–î
            submitted_answer=submitted_answer or '–§–æ—Ç–æ —Ä–µ—à–µ–Ω–∏—è',
            is_correct=is_correct,
            points_awarded=points_awarded,
            solution_photo=solution_photo,
            ai_analysis={
                'gemini_check': check_result,
                'problem_data': {
                    'title': problem_data['title'],
                    'difficulty': problem_data['difficulty_score']
                }
            }
        )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        index_change = user.profile.update_index(
            problem_data['difficulty_score'],
            is_correct
        )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º weekly_score –≤ –∞—Ä–µ–Ω–µ
        from arena.models import ArenaRank
        arena_rank, created = ArenaRank.objects.get_or_create(
            user=user,
            defaults={
                'current_index': user.profile.al_khwarizmi_index,
                'current_division': ArenaRank.get_division_from_index(
                    user.profile.al_khwarizmi_index
                )
            }
        )
        if is_correct:
            arena_rank.weekly_score += points_awarded
            arena_rank.current_index = user.profile.al_khwarizmi_index
            arena_rank.current_division = ArenaRank.get_division_from_index(
                user.profile.al_khwarizmi_index
            )
            arena_rank.save()
            arena_rank.update_rank()  # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        response_data = {
            'is_correct': is_correct,
            'points_awarded': points_awarded,
            'index_change': index_change,
            'new_index': user.profile.al_khwarizmi_index,
            'correct_answer': problem_data['correct_answer'],
            'solution_steps': problem_data.get('solution_steps', []),
            'ai_feedback': check_result.get('feedback', ''),
            'confidence': confidence,
            'attempt_id': attempt.id
        }
        
        logger.info(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username} | –û—á–∫–∏: {points_awarded} | –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞: {index_change}")
        
        return Response(response_data, status=status.HTTP_200_OK)
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–µ—à–µ–Ω–∏—è | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username} | –û—à–∏–±–∫–∞: {str(e)}")
        logger.exception("–ü–æ–ª–Ω—ã–π traceback:")
        return Response({
            'error': f'–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—à–µ–Ω–∏—è: {str(e)}'
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def available_topics(request):
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    GET /api/problems/topics-ai/
    """
    topics = Topic.objects.all().values('id', 'name', 'description', 'difficulty_base')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò
    ai_topics = [
        {
            'id': 'ai_algebra',
            'name': '–ê–ª–≥–µ–±—Ä–∞: –°–º–µ—à–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏',
            'description': '–†–∞–∑–ª–∏—á–Ω—ã–µ –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –ò–ò',
            'difficulty_base': 1000
        },
        {
            'id': 'ai_geometry',
            'name': '–ì–µ–æ–º–µ—Ç—Ä–∏—è: –°–º–µ—à–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏',
            'description': '–†–∞–∑–ª–∏—á–Ω—ã–µ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –ò–ò',
            'difficulty_base': 1200
        },
        {
            'id': 'ai_calculus',
            'name': '–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑',
            'description': '–ó–∞–¥–∞—á–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–º, –∏–Ω—Ç–µ–≥—Ä–∞–ª–∞–º –∏ –ø—Ä–µ–¥–µ–ª–∞–º',
            'difficulty_base': 1500
        },
        {
            'id': 'ai_probability',
            'name': '–¢–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π',
            'description': '–ó–∞–¥–∞—á–∏ –Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É',
            'difficulty_base': 1300
        }
    ]
    
    return Response({
        'db_topics': list(topics),
        'ai_topics': ai_topics
    }, status=status.HTTP_200_OK)
